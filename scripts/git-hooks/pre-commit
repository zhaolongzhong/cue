#!/bin/bash

# Get current branch
branch="$(git symbolic-ref --short HEAD 2>/dev/null)"
[[ $? -ne 0 ]] && echo "Not on any branch" && exit 1

# Protected branches
protected_branches=('main' 'master' 'release' 'production' 'develop')
for protected_branch in "${protected_branches[@]}"; do
    if [[ "$branch" = "$protected_branch" ]]; then
        echo "ERROR: Direct commits to protected '$branch' branch are not allowed."
        echo "Workflow: create non-protected branch -> commit -> push remote"
        exit 1
    fi
done

# Branch naming convention
branch_pattern="^(feat|feature|bugfix|docs|style|refactor|test|chore)/.+"
[[ ! $branch =~ $branch_pattern ]] && echo "Invalid branch name: use {type}/{name} format" && exit 1

# Run format script
./scripts/format.sh
format_exit_code=$?

# Handle formatting changes
if ! git diff --quiet; then
    git add -A
    current_head=$(git rev-parse HEAD)
    git commit --amend -C HEAD --no-verify
    format_exit_code=$?
    [[ $format_exit_code -eq 0 ]] || (git reset --hard $current_head && exit 1)
fi

[[ $format_exit_code -ne 0 ]] && echo "Format check failed" && exit 1

exit 0
